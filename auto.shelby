#!/usr/bin/env bash
set -euo pipefail

# --- Kiá»ƒm tra shelby ---
if ! command -v shelby &>/dev/null; then
  echo "KhÃ´ng tÃ¬m tháº¥y lá»‡nh 'shelby'. HÃ£y cÃ i Ä‘áº·t trÆ°á»›c khi cháº¡y script."
  exit 1
fi

# --- Cáº¥u hÃ¬nh ---
DATA_DIR="/root/shelby/data"
DEST_DIR="files"

# --- B1: chá»n account ngáº«u nhiÃªn 1 hoáº·c 2 ---
i=$((RANDOM % 2 + 1))
echo "Äang dÃ¹ng tÃ i khoáº£n Shelby sá»‘: $i"
shelby account use "$i"

# --- B2: chá»n file ngáº«u nhiÃªn ---
mapfile -d '' -t files < <(find "$DATA_DIR" -maxdepth 1 -type f -print0)
if [ "${#files[@]}" -eq 0 ]; then
  echo "KhÃ´ng cÃ³ file nÃ o trong $DATA_DIR Ä‘á»ƒ upload. ThoÃ¡t."
  exit 1
fi

idx=$((RANDOM % ${#files[@]}))
fullpath="${files[$idx]}"
filename="$(basename "$fullpath")"
echo "ğŸ“„ File Ä‘Æ°á»£c chá»n: $filename"

# --- B3: thá»i háº¡n ngáº«u nhiÃªn 365â€“720 ngÃ y ---
EXPIRATION_DAYS=$((RANDOM % 356 + 365))
EXPIRATION="${EXPIRATION_DAYS}d"

src_path="$DATA_DIR/$filename"
dst_path="$DEST_DIR/$filename"

echo "Upload: $src_path â†’ $dst_path (háº¿t háº¡n sau $EXPIRATION_DAYS ngÃ y)"

# --- B4: cháº¡y lá»‡nh upload cÃ³ auto-confirm ---
output_file="$(mktemp)"
if shelby upload "$src_path" "$dst_path" \
  --expiration "$EXPIRATION" \
  --assume-yes | tee "$output_file"; then
  # --- Kiá»ƒm tra xem cÃ³ lá»—i crypto hoáº·c dáº¥u âœ– khÃ´ng ---
  if grep -q "crypto is not defined" "$output_file" || grep -q "âœ–" "$output_file"; then
    echo "Upload cÃ³ lá»—i, KHÃ”NG xÃ³a file Ä‘á»ƒ kiá»ƒm tra thá»§ cÃ´ng."
  else
    echo "Upload thÃ nh cÃ´ng! XÃ³a file gá»‘c Ä‘á»ƒ trÃ¡nh trÃ¹ng láº§n sau..."
    rm -f -- "$src_path"
    echo "ÄÃ£ xÃ³a $src_path"
  fi
else
  echo "Upload tháº¥t báº¡i (lá»‡nh shelby tráº£ lá»—i)."
fi

# Dá»n file táº¡m
rm -f "$output_file"
